(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/shop/QRCode"],{"02d0":function(t,n,a){"use strict";(function(t,i){Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var o=s(a("4795")),c=a("ac69");function s(e){return e&&e.__esModule?e:{default:e}}function r(e,t,n,a,i,o,c){try{var s=e[o](c),r=s.value}catch(u){return void n(u)}s.done?t(r):Promise.resolve(r).then(a,i)}function u(e){return function(){var t=this,n=arguments;return new Promise((function(a,i){var o=e.apply(t,n);function c(e){r(o,a,i,c,s,"next",e)}function s(e){r(o,a,i,c,s,"throw",e)}c(void 0)}))}}var l,f=function(){Promise.all([a.e("common/vendor"),a.e("components/tki-qrcode/tki-qrcode")]).then(function(){return resolve(a("3954"))}.bind(null,a)).catch(a.oe)},d={components:{tkiQrcode:f},data:function(){return{ifShow:!0,val:"",size:200,unit:"upx",pdground:"#F96D4E",icon:"",iconsize:40,lv:3,onval:!1,loadMake:!0,src:"",canvasW:0,canvasH:0,imgSrc:"https://wxhyx-cdn.aisspc.cn/static/qr_bg.png",Title:"",QrSrc:"",LineType:!0,tempFilePath:[],finished:!1,openSettingBtnHidden:!0,canvasToImageFileError:1,canvasToImageFileDelayTime:200,canvasToImageFileQuality:1}},onLoad:function(){var e=this.$db.get("shopInfo");this.val="https://wxhyx.aisspc.cn?id=".concat(e.id),this.Title=e.shop_title,this.getErCode()},mounted:function(){l=this},methods:{getErCode:function(){var e=this.$db.get("shopInfo");this.$http.getErCode({scene:e.id},(function(e){t.showLoading({title:"加载中...",mask:!0}),(0,c.base64ToPath)(e).then((function(e){l.QrSrc=e})).catch((function(e){console.warn(e)})),l.OnCanvas()}))},toBuffer:function(e){for(var t=new i(e.byteLength),n=new Uint8Array(e),a=0;a<t.length;++a)t[a]=n[a];return t},qrR:function(e){console.log("res",e)},handleSetting:function(e){e.detail.authSetting["scope.writePhotosAlbum"]?l.openSettingBtnHidden=!0:l.openSettingBtnHidden=!1},saveImage:function(e){t.getSetting({success:function(e){e.authSetting["scope.writePhotosAlbum"]?l.saveImgToLocal():t.authorize({scope:"scope.writePhotosAlbum",success:function(){l.saveImgToLocal(),console.log("相册授权成功")},fail:function(){l.openSettingBtnHidden=!1,t.showToast({icon:"none",title:"相册授权失败,请重试!"})}})}})},saveImgToLocal:function(e){var n=l.tempFilePath[0];n?t.showActionSheet({itemList:["保存图片"],success:function(e){t.showLoading({title:"保存中...",mask:!0}),t.downloadFile({url:n,success:function(e){"downloadFile:ok"==e.errMsg&&t.saveImageToPhotosAlbum({filePath:e.tempFilePath,success:function(){t.showToast({title:"保存成功",icon:"success"})},fail:function(){t.showToast({title:"保存失败",icon:"none"})}})},fail:function(e){t.showToast({icon:"none",title:"请重试!",mask:!0})},complete:function(){}})},fail:function(e){console.log(e)}}):t.showToast({icon:"none",title:"请重试!",mask:!0})},previewImage:function(){t.previewImage({urls:this.tempFilePath,current:""})},OnCanvas:function(){var e=this;return u(o.default.mark((function n(){var a,i,c,s,r,u,f,d,h,m,p,g,v;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return l.ctx=t.createCanvasContext("myCanvas",e),a=t.upx2px(662),i=t.upx2px(0),c=t.upx2px(150),s=0,n.next=5,l.getImageInfo({imgSrc:l.imgSrc});case 5:return r=n.sent,n.next=8,l.getImageInfo({imgSrc:l.QrSrc});case 8:u=n.sent,f=[r.width,r.height],d=[u.width,u.height],h=a-2*i,f[0]!=h&&(f[1]=Math.floor(h/f[0]*f[1]),f[0]=h),d[0]!=c&&(d[1]=Math.floor(c/d[0]*d[1]),d[0]=c),l.canvasW=a,l.canvasH=f[1],l.ctx.setFillStyle("#fff"),l.ctx.fillRect(0,0,a,l.canvasH),l.ctx.drawImage(r.path,i,i,f[0],f[1]),l.ctx.setFontSize(t.upx2px(40)),l.ctx.setFillStyle("#F4E0AD"),l.ctx.setTextAlign("center"),m=0,p=t.upx2px(90),g=1,v=0;case 26:if(!(v<l.Title.length)){n.next=48;break}if(s+=l.ctx.measureText(l.Title[v]).width,!(s>f[0])){n.next=44;break}if(2!=g||!l.LineType){n.next=37;break}return l.ctx.fillText(l.Title.substring(m,v-8)+"...",a/2,p),s=0,m=v,g++,n.abrupt("break",48);case 37:l.ctx.fillText(l.Title.substring(m,v),a/2,p),s=0,p+=30,m=v,g++;case 42:n.next=45;break;case 44:v==l.Title.length-1&&(l.ctx.fillText(l.Title.substring(m,v+1),a/2,p),s=0);case 45:v++,n.next=26;break;case 48:l.ctx.drawImage(u.path,a/2-2.2*d[0]/2,t.upx2px(184),2.2*d[0],2.2*d[1]),setTimeout((function(){l.ctx.draw(!0,(function(e){l.getNewImage(),t.hideLoading(),l.finished=!0}))}),l.canvasToImageFileDelayTime);case 50:case"end":return n.stop()}}),n)})))()},getImageInfo:function(e){return u(o.default.mark((function n(){var a;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return a=e.imgSrc,n.abrupt("return",new Promise((function(e,n){t.getImageInfo({src:a,success:function(t){e(t)},fail:function(e){n(e)}})})));case 2:case"end":return n.stop()}}),n)})))()},getNewImage:function(){var n=this,a=this;t.canvasToTempFilePath({canvasId:"myCanvas",quality:a.canvasToImageFileQuality,fail:function(t){var n=t.errMsg;"canvasToTempFilePath:fail:create bitmap failed"===n&&(a.canvasToImageFileError<=5?(a.getNewImageCount+=1,a.canvasToImageFileDelayTime+=100,a.canvasToImageFileQuality-=.1,a.getNewImage()):console.error("[canvasToImageFile]×生成海报失败，尝试次数:"+a.canvasToImageFileError+",延迟:"+a.canvasToImageFileDelayTime+",画质:"+a.canvasToImageFileQuality,e))},complete:function(e){console.log("res.tempFilePath",e);var a=n.$db.get("userinfo")||"";t.uploadFile({url:"https://wxhyx.aisspc.cn/addons/qiniu/index/upload",filePath:e.tempFilePath,name:"file",fileType:"image",headers:{Accept:"application/json","Content-Type":"multipart/form-data"},formData:{method:"images.upload",upfile:e.tempFilePath,token:a.token},success:function(e){var t=JSON.parse(e.data),a="https://wxhyx-cdn.aisspc.cn".concat(t.data.url);n.tempFilePath.push(a),console.log("上传图片",n.tempFilePath)},complete:function(){},fail:function(e){console.log("this is errormes ")}})}},this)}}};n.default=d}).call(this,a("543d")["default"],a("b639").Buffer)},"118d":function(e,t,n){"use strict";var a,i=function(){var e=this,t=e.$createElement;e._self._c},o=[];n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return o})),n.d(t,"a",(function(){return a}))},"3cb0":function(e,t,n){"use strict";(function(e){n("b1d0");a(n("66fd"));var t=a(n("cc28"));function a(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,n("543d")["createPage"])},"971b":function(e,t,n){"use strict";var a=n("b74f"),i=n.n(a);i.a},b74f:function(e,t,n){},cc28:function(e,t,n){"use strict";n.r(t);var a=n("118d"),i=n("f221");for(var o in i)"default"!==o&&function(e){n.d(t,e,(function(){return i[e]}))}(o);n("971b");var c,s=n("f0c5"),r=Object(s["a"])(i["default"],a["b"],a["c"],!1,null,"2f2a65b7",null,!1,a["a"],c);t["default"]=r.exports},f221:function(e,t,n){"use strict";n.r(t);var a=n("02d0"),i=n.n(a);for(var o in a)"default"!==o&&function(e){n.d(t,e,(function(){return a[e]}))}(o);t["default"]=i.a}},[["3cb0","common/runtime","common/vendor"]]]);